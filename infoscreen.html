<html>
<head>
    <meta charset="utf-8" />
    <script src="https://www.youtube.com/player_api"></script>    
    <style>
        body{
            background-color: white;
            color: black;
            font-family: "Ubuntu Mono", monospace;
        }

        #clock{
            width: 100%;
            font-size: 25vh;
            text-align: center;
        }
        h1{
            font-size: 40pt;
            /*text-decoration: underline;*/
        }
        .linecontainer{
            display: inline-block;
            width: 32vw;
            /*border: 1px solid red;*/
            font-size: 200%;
            margin-right: 0.2em;
        }
        .linename{
            font-weight: bold;
            width: 2em;
        }
        .time{
            text-align: right;
        }
        .delay{
            padding-left: 0.2em;
            color: red;
            text-align: left;
        }
        table{
            width: 100%;
            font-size: 28pt;
        }

        tr{
            background-color: #fefefe;
        }
        tr:nth-child(2n+1){
            background-color: #efefef;
        }


        #temperature{
            float:right;
            font-size: 32pt;
        }

        #cputemp{
            font-weight: bold;
            color: blue;
            transition: color 1s;
        }

        #cputemp.on{
            color: red;
        }

        #ytplayer{
            position: absolute;
            right: 0;
            bottom: 0;
            margin: 0;
            padding: 0;
            z-index: 30;
        }
    </style>
</head>
<body>
    <div id="clock"></div>
    <script>
        setInterval(() => {
            var d = new Date();
            document.getElementById('clock').innerText = `${('00' + d.getHours()).slice(-2)}:${('00' + d.getMinutes()).slice(-2)}:${('00' + d.getSeconds()).slice(-2)}`;
        }, 500);
    </script>
    <div id="temperature">CPU-Temperatur: <span id="cputemp">NaN</span>°C</div>
    <script>
        function makeTempRequest(){
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                var DONE = this.DONE || 4;
                if (this.readyState === DONE){
                    document.getElementById('cputemp').innerText = request.responseText;
                }
            };
            request.open('GET', 'http://localhost:8123/temperature', true);
            request.send();
        }
        function makePumpRequest(){
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                var DONE = this.DONE || 4;
                if (this.readyState === DONE){
                    if(/ON/.test(request.responseText)){
                        document.getElementById('cputemp').classList.add('on');
                    }else{
                        document.getElementById('cputemp').classList.remove('on');

                    }
                }
            };
            request.open('GET', 'http://localhost:8123/pump', true);
            request.send();
        }
        setInterval(makeTempRequest, 2000);
        setInterval(makePumpRequest, 5000);
    </script>
    <h1>Abfahrten Südfriedhof:</h1>
    <div id="bus">

    </div>
    <div id="ytplayer">

    </div>
    <script>
        function cdiv(parent, classes){
            let div = document.createElement('div');
            if(classes){
                classes.forEach(c => div.classList.add(c));
            }
            parent.appendChild(div);
            return div;
        }

        function ctd(parent, classes, text){
            let td = document.createElement('td');
            if(classes){
                classes.forEach(c => td.classList.add(c));
            }
            td.innerText = text;
            parent.appendChild(td);
            return td;
        }

        function strTimeToMinuteInt(strtime){
            let parts = strtime.split(':');
            return (parseInt(parts[0]) * 60) + parseInt(parts[1]);
        }

        function parseKVGData(kvgdata){
            let lines = {};
            let lineNames = [];
            kvgdata.actual.forEach(a => {
                let line = a.patternText;
                if(!lines[line]){
                    lines[line] = [];
                    lineNames.push(line);
                }
                let lobj = {};
                lobj.direction = a.direction;
                lobj.arrival = a.actualTime;
                lobj.relativeMinutes = parseInt(a.actualRelativeTime / 60);
                lobj.delay = strTimeToMinuteInt(a.actualTime) - strTimeToMinuteInt(a.plannedTime);
                lines[line].push(lobj);
            });

            document.getElementById('bus').innerHTML = "";

            lineNames.forEach(ln => {
                let lineContainer = cdiv(document.getElementById('bus'), ['linecontainer']);
                let table = document.createElement('table');
                table.setAttribute('cellspacing','0');
                lineContainer.appendChild(table);
                lines[ln].forEach(route => {
                    let row = document.createElement('tr');
                    ctd(row, ['linename'],ln)
                    ctd(row,['direction'],route.direction);
                    ctd(row,['time'],route.relativeMinutes);
                    let delaytext = "";
                    if(route.delay){
                        delaytext = "(+" + route.delay + ")";
                    }
                    ctd(row,['delay'],delaytext);
                    table.appendChild(row);
                });
            });

            console.log(lines);
        }

        function makeKVGRequest(){
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                var DONE = this.DONE || 4;
                if (this.readyState === DONE){
                    var busState = JSON.parse(request.responseText);
                    parseKVGData(busState);
                }
            };
            request.open('GET', 'http://localhost:8123/update', true);
            request.send();
        }
        setInterval(makeKVGRequest,60 * 1000);
        makeKVGRequest();

        var pageYT = {
            v: "",
            pause: false,
            active: false
        };

        var player;

        function handleYTRequest(youtube){
            console.log(youtube, pageYT);
            if((youtube.active == true) && (pageYT.active == false)){//new video
                console.log("new video: " + youtube.v);
                pageYT.v = youtube.v;
                pageYT.active = true;
                pageYT.pause = false;
                player = new YT.Player('ytplayer', {
                    height: '360',
                    width: '640',
                    videoId: youtube.v,
                    playerVars: {
                        autoplay: 1
                    }
                });
            }
            if(youtube.active == false && pageYT.active == true){//stop video
                console.log("stop");
                pageYT.v = "";
                pageYT.active = false;
                pageYT.pause = false;
                player.destroy();
            }
            if(youtube.active && (youtube.pause == true && pageYT.pause == false)){//pause video
                console.log("pause");
                console.log(player);
                pageYT.pause = true;
                player.pauseVideo();
            }
            if(youtube.active && (youtube.pause == false && pageYT.pause == true)){//unpause video
                console.log("unpause");
                pageYT.pause = false;
                player.playVideo();
            }
        }

        function makeYTRequest(){
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                var DONE = this.DONE || 4;
                if (this.readyState === DONE){
                    var ytstate = JSON.parse(request.responseText);
                    handleYTRequest(ytstate);
                }
            };
            request.open('GET', 'http://localhost:8123/youtube?update=true', true);
            request.send();
        }

        function makeClearingYTRequest(){
            var request = new XMLHttpRequest();
            request.onreadystatechange = function () {
                var DONE = this.DONE || 4;
                if (this.readyState === DONE){
                    var ytstate = JSON.parse(request.responseText);
                    handleYTRequest(ytstate);
                }
            };
            request.open('GET', 'http://localhost:8123/youtube?active=false&pause=false&v=_', true);
            request.send();
        }
        makeClearingYTRequest();
        setInterval(makeYTRequest,1000);
    </script>
</body>
</html>
